<div class="archive">
  <!-- Tags -->
  <div class="tags">
    {% for tag in site.data.tags %} {% if site.data.tags contains tag %}
    <div data-tag="{{ tag }}" class="tag">{{ tag }}</div>
    {% endif %} {% endfor %}
  </div>
  <!-- SitePost -->
  {% for post in site.posts %} {% unless post.next %}
  <p class="archive_year">{{ post.date | date: '%Y' }}</p>
  {% else %} {% capture year %}{{ post.date | date: '%Y' }}{% endcapture %} {%
  capture nextyear %}{{ post.next.date | date: '%Y' }}{% endcapture %} {% if
  year != nextyear %}
  <p class="archive_year">{{ post.date | date: '%Y' }}</p>
  {% endif %} {% endunless %}
  <ul class="posts">
    <li data-tags="{% for tag in post.tags %}{{tag}} {% endfor %}">
      <time class="archive_date" datetime="{{ post.date | date_to_xmlschema }}">
        {{ post.date | date: "%b %d" }}
      </time>
      <div class="archive_title">
        <a href="{{ post.url | relative_url }}"> {{ post.title | escape }} </a>
      </div>
    </li>
  </ul>
  {% endfor %}
</div>
<script>
  $(document).ready(() => {
    filters = [];

    $(".tag").on("click", (event) => {
      const targetTag = event.target.getAttribute("data-tag");
      $(event.target).toggleClass("selected");
      if (filters.includes(targetTag)) {
        setFilters(filters.filter((f) => f !== targetTag));
      } else {
        setFilters([...filters, targetTag]);
      }
    });

    function setFilters(nextFilters) {
      console.log("changed filters from ", filters, nextFilters);
      filters = nextFilters;
      applyFilters(nextFilters);
    }

    function applyFilters(filters) {
      $(".posts li").each((index, element) => {
        if (filters.length === 0) {
          $(element).show();
          return;
        }

        const tags = element.getAttribute("data-tags").trim().split(" ");
        const containsAnyFilter =
          filters.filter((tag) => tags.includes(tag)).length > 0;

        if (containsAnyFilter) {
          $(element).show();
        } else {
          $(element).hide();
        }
      });
    }
  });
</script>
