---
date: 2020-09-15
title: ê°„ë‹¨í•œ Flask Server ë§Œë“¤ê¸°
tags: [ì›¹]
comments: false
---

## ë™ê¸°

- ë¦¬ì•¡íŠ¸ 3ì£¼ì°¨ ë¯¸ì…˜ì—ì„œ í•„ìš”í•œ vote system api serverë¥¼ ë§Œë“¤ê³ ì í–ˆë‹¤.
- express.jsë„ ì¶©ë¶„íˆ ë¯¸ë‹ˆë©€í•œ microframeworkê¸´ í•˜ì§€ë§Œ.. microframeworkì˜ ê·¹í•œì„ í•œë²ˆ ëŠê»´ë³´ê³  ì‹¶ì—ˆë‹¤.
- pythonì˜ djangoëŠ” ê³µë£¡ì²˜ëŸ¼ ë¬´ê²ê³ ... ëŠë¦¬ê³ ... ë­ ê³µë¶€í•´ì•¼ í•˜ëŠ”ê²Œ ë§ì•„ì„œ, Flaskë¥¼ ì¨ë³´ê¸°ë¡œ í–ˆë‹¤.

## ìš”êµ¬ì‚¬í•­

1. ë¡œê·¸ì¸, íšŒì›ê°€ì…, JWT ì¸ì¦ ê¸°ëŠ¥ì„ ë°˜ë“œì‹œ í¬í•¨í•  ê²ƒ.
2. Candidate ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°, Candidateì— íˆ¬í‘œí•˜ê¸° ë“±ì„ í•  ìˆ˜ ìˆë‹¤.
3. CORSë¥¼ ì§€ì›í•˜ë„ë¡ ì‘ë‹µ í—¤ë”ì— ì ì–´ë‘”ë‹¤. (í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ì™€ ë°±ì—”ë“œ ì„œë²„ê°€ ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸ì´ê¸° ë•Œë¬¸!)

## ì‚¬ìš©í•œ íŒ¨í‚¤ì§€ë“¤

1. TinyDB

   - ìš°ì„ , sqlì„ ì‚¬ìš©í•˜ê¸°ëŠ” ë„ˆë¬´ ë²…ì°¨ë‹¤. ì‘ì€ ê·œëª¨ì˜, jsoníŒŒì¼ë¡œ ì €ì¥ë  ìˆ˜ ìˆëŠ”, ì–´ë–»ê²Œ ë³´ë©´ [NeDB](https://github.com/louischatriot/nedb) í˜¹ì€ [lowDB](https://github.com/typicode/lowdb)ì˜ python êµ¬í˜„ì²´? ê°™ì€ ê±¸ ì°¾ì•„ë³´ì•˜ë‹¤. ê·¸ë˜ì„œ ì°¾ì€ ê²ƒì´ [tinyDB](https://tinydb.readthedocs.io/en/latest/) ì˜€ë‹¤.
   - ì´ë¦„ì²˜ëŸ¼ ì¡°ê·¸ë§ˆí•œ DBì´ë‹¤. ëŒ€í™”í˜• ì½˜ì†”ì„ ì‚¬ìš©í•˜ë©´ ë§ˆì¹˜ DBMSì˜ ì¿¼ë¦¬ ì½˜ì†” í˜¹ì€ Djangoì˜ ORM shell ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

2. Cerberus
   - Validatorì˜ ì¼ì¢…ì´ë‹¤. objectê°€ í•´ë‹¹ schema í˜•íƒœë¡œ structured ëëŠ”ì§€ í™•ì¸í•œë‹¤.
   - Request Validationì— ì‚¬ìš©í–ˆë‹¤. (íŠ¹íˆ POST ìš”ì²­)
   - TinyDBì™€ì˜ ì—°ë™ Layerì—ì„œë„ ì‚¬ìš©í•´ë³´ë ¤ê³  í–ˆì§€ë§Œ... ì—¬ëŸ¬ëª¨ë¡œ ì œì•½ì´ ì¢€ ìˆë‹¤.

## ê²°ê³¼ë¬¼

- deployë¥¼ í•˜ì§„ ì•Šì•˜ê³ , ì†ŒìŠ¤ì½”ë“œëŠ” [ì—¬ê¸°](https://github.com/sebastianrcnt/ceos-vote) ì—ì„œ í™•ì¸í•´ë³¼ ìˆ˜ ìˆë‹¤.

### 1. ì¼ë‹¨ í•„ìš”í•œ íŒ¨í‚¤ì§€ë“¤ë¶€í„° import í•œë‹¤.

```python
from flask import Flask, json, request, Response, jsonify
from flask_cors import CORS

from tinydb import TinyDB, Query, where
from cerberus import Validator
from urllib.parse import parse_qs

import jwt
```

- tinydb, cerberusëŠ” ìœ„ì—ì„œ ì–¸ê¸‰!
- flask_corsëŠ” `CORS(app)`í•œë²ˆ í•´ì£¼ë©´ flask appì— CORS ê¸°ëŠ¥ì„ ë„£ì–´ì¤€ë‹¤.
- `urllib.parse`ì˜ `parse_qs` ë©”ì†Œë“œëŠ” ì¿¼ë¦¬ ìŠ¤íŠ¸ë§ ex) `/candidates?id=3`ì„ parsingí•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•œ ê²ƒ!

### 2. Flask Appì„ ë§Œë“¤ê³ , DBë¥¼ ì…‹íŒ…í•œë‹¤!

```python
app = Flask(__name__)
CORS(app)

db = TinyDB('./db.json')

JWT_SECRET_KEY='secret'

Users = db.table('users')
Candidates = db.table('candidates')
```

- í˜„ì¬ í´ë”ì˜ `db.json`ì´ë€ íŒŒì¼ì„ ë§Œë“¤ì—ˆë‹¤.
- JWT_SECRET_KEYëŠ” ì´í›„ ì„¤ëª…ë“œë¦¼
- Tableì€ ì „ì²´ DBì˜ ì†ì„±ê°’ìœ¼ë¡œ ìƒì„±ëœë‹¤. ì•„ë˜ëŠ” `db.json` íŒŒì¼ ë‚´ë¶€.

```json
{
  "candidates": {
    "1": {
      "name": "\uc815\uc2dc\uc6d0",
      "voteCount": 4
    },
    /*...*/
    "10": {
      "name": "\ud669\uc720\ub098",
      "voteCount": 0
    }
  },
  "users": {
    "1": {
      "email": "user1@ceos.or.kr",
      "name": "\uc720\uc8001",
      "password": "secret"
    }
  }
}
```

- ë³´ì´ê² ì§€ë§Œ í•œê¸€ì´ ê¹¨ì ¸ì„œ ì €ì¥ëœë‹¤. ìƒê´€ì—†ë‹¤. Controllerì—ì„œ ì¸ì½”ë”©í•´ì£¼ë©´ ëœë‹¤!

### 3. Request Schema, Request Validatorë¥¼ ì‘ì„±í•œë‹¤.

```python
# Schemas
UserGenerationDataSchema = {
  'email': {'type': 'string', 'required': True},
  'name': {'type': 'string', 'required': True},
  'password': {'type': 'string', 'required': True},
}

LoginDataSchema = {
  'email': {'type': 'string', 'required': True},
  'password': {'type': 'string', 'required': True},
}

UserGenerationDataSchemaValidator = Validator(UserGenerationDataSchema)
LoginDataSchemaValidator = Validator(LoginDataSchema)
```

- ì´ë¦„ì´ ë¬´ì§€ë§‰ì§€í•˜ê²Œ ê¸¸ë‹¤. ê·¸ì¹˜ë§Œ ì• ë§¤í•œ ì´ë¦„ë³´ë‹¤ëŠ” ì¤‘ë³µë˜ëŠ” ì˜ë¯¸ê°€ ì—†ëŠ” í•œì—ì„œ ê°€ì¥ descriptiveí•˜ê²Œ ì“°ëŠ”ê²Œ ì¢‹ë‹¤ê³  í–ˆìœ¼ë‹ˆ...(Clean Code ì°¸ê³ ..)
- ì—¬íŠ¼ ì´ëŸ° ë°©ì‹ìœ¼ë¡œ Request Bodyì˜ Schemaë¥¼ ë„£ì–´ì¤€ë‹¤

### 4. Candidatesë¥¼ í•˜ë“œì½”ë”©ìœ¼ë¡œ ì¶”ê°€

```python
Candidates.remove((lambda x: True))
Candidates.insert_multiple([
  {'name': 'ì •ì‹œì›', 'voteCount': 0},
  {'name': 'ê³ ì€', 'voteCount': 0},
  {'name': 'ìœ í˜„ìš°', 'voteCount': 0},
  {'name': 'ê¹€*ì˜¤', 'voteCount': 0},
  {'name': 'ë¬¸*ë¹ˆ', 'voteCount': 0},
  {'name': 'ë¬¸*ì§„', 'voteCount': 0},
  {'name': 'ì„œ*ë¹ˆ', 'voteCount': 0},
  {'name': 'ì´*ìš©', 'voteCount': 0},
  {'name': 'ì¥*í›ˆ', 'voteCount': 0},
  {'name': 'í™©*ë‚˜', 'voteCount': 0},
])
```

- CandidatesëŠ” í•˜ë“œì½”ë”© í•˜ëŠ” í¸ì´ ì¢‹ê² ë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì•¼í•˜ëŠ” ê²½ìš°ë„ ë§ê³ , ì–´ì°¨í”¼ ìŠ¤í„°ë””ì›ë“¤ì˜ ì´ë¦„ì€ ë°”ë€Œì§€ ì•Šì„ í…Œë‹ˆ?
- POSTë¡œ ì¼ì¼íˆ ìš”ì²­ ë³´ë‚´ëŠ” ê±¸ ìƒìƒí•˜ë‹ˆ.. ë”ì°í•˜ë‹¤.

### 5. ëŒ€ë§ì˜ Request Handlers(Controllers)

```python
@app.route('/auth/signup', methods=['POST'])
def generateUser():
  userGenerationData = request.get_json(force=True)
  if not UserGenerationDataSchemaValidator(userGenerationData):
    return Response(response="ì˜¬ë°”ë¥¸ ìš”ì²­ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤", status=400)

  if Users.contains(Query()['email']==userGenerationData['email']):
    return Response(response="í•´ë‹¹ ìœ ì €ì— ëŒ€í•œ ì´ë©”ì¼ì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤", status=403)

  Users.insert(userGenerationData);
  return Response(response="ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤", status=201)

@app.route('/auth/login', methods=['POST'])
def verifyUser():
  loginData = request.get_json(force=True)
  if not LoginDataSchemaValidator(loginData):
    return Response(response="ì˜¬ë°”ë¥¸ ìš”ì²­ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤", status=400)

  if Users.contains((Query()['email'] == loginData['email']) and (Query()['password'] == loginData['password'])):
    return jwt.encode({'email': loginData['email']}, JWT_SECRET_KEY)
  else:
    return Response(response="ì´ë©”ì¼ í˜¹ì€ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", status=404)

@app.route('/auth/token', methods=['GET'])
def verifyToken():
  query = parse_qs(request.query_string)
  if not query.get(b'token'):
    return Response(response="token ì¿¼ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", status=400)
  token = query.get(b'token')[0]
  try:
    decoded = jwt.decode(token, JWT_SECRET_KEY)
    return Response(response="ìœ íš¨í•œ í† í°ì…ë‹ˆë‹¤", status=200)
  except Exception as e:
    print(e)
    return Response(response="ìœ íš¨í•˜ì§€ ì•Šì€ í† í°ì…ë‹ˆë‹¤", status=401)
    pass

@app.route('/candidates', methods=['GET'])
def getAllCandidates():
  candidateList = Candidates.all()
  for candidate in candidateList:
    candidate['id'] = candidate.doc_id

  return Response(response=json.dumps(candidateList, ensure_ascii=False), mimetype="application/json")

@app.route('/vote')
def vote():
  query = parse_qs(request.query_string)
  if not query.get(b'id'):
    return Response(response="id íŒŒë¼ë¯¸í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", status=400)

  id = query.get(b'id')[0].decode('utf-8')
  targetCandidate = Candidates.get(doc_id=int(id))
  if not targetCandidate:
    return Response(response="í•´ë‹¹ idë¥¼ ê°€ì§„ í›„ë³´ìê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤", status=404)

  Candidates.update({'voteCount': targetCandidate['voteCount'] + 1}, doc_ids=[int(id)])
  return Response(status=200)

app.run(debug=True)
```

- ìš”ë ‡ê²Œ ì§°ë‹¤. `doc_ids`ì™€ `Query()`ì˜ ê°œë…ì„ ì¡ëŠ”ë° ì‹œê°„ì´ ì¢€ ê±¸ë ¸ë‹¤.
- `Node.js`ì— ë¹„í•´ì„œ ìµìˆ™í•˜ì§€ ì•Šë‹¤. ë…¸ë“œì—ì„œëŠ” ì¸ì½”ë”©ë„ ì•Œì•„ì„œ ì²˜ë¦¬í•´ì£¼ê³  ì¢‹ì€ë°..
- Nodeì— ë¹„í•˜ì—¬ ì•„ì§ ê²½í—˜ì´ ì—†ì–´ì„œ ì½”ë“œ íŒ¨í„´ì´ ì •í˜•í™”í•˜ê¸°ëŠ” ì–´ë ¤ìš´ ê²ƒ ê°™ë‹¤. JavaScriptê°€ ì–¼ë§ˆë‚˜ í›Œë¥­í•œ ì–¸ì–´ì¸ì§€ ìƒˆì‚¼ ê¹¨ë‹«ëŠ”ë‹¤.

## ê²°ë¡ 

- ë‚¨ë“¤ ê·€ì°®ë‹¤ê³  ì•ˆí•˜ë˜ ì§“ ë‚˜ì„œì„œ í•˜ë˜ ë‚´ê°€ ì´ë²ˆì— ë˜ í­ì£¼(ğŸš‚)í–ˆë‹¤....
- ê·¸ë˜ë„ ì´ë ‡ê²Œ ë‹¤ì–‘í•œ í”„ë ˆì„ì›Œí¬/ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°°ì›Œê°€ëŠ” ê²Œ ë‚˜ë¦„ ì¬ë¯¸ìˆë‹¤!
- ë‹¤ìŒì€ Swift, Kotlin, Java, ASP.NET ë“±ìœ¼ë¡œë„ í•œë²ˆ ë§Œë“¤ì–´ë³´ì•„ì•¼ê² ë‹¤.
- "ê°™ì€ ê±¸ ì—¬ëŸ¬ ë°©ë²•(ì–¸ì–´)ë¡œ ë§Œë“¤ì–´ë³´ì"ê°€ ì¢‹ì€ ìì„¸ì¸ ê²ƒ ê°™ë‹¤. ì‹¤ì œë¡œ í”„ë¡œë•ì…˜ì—ì„œ í™œìš©í•˜ì§€ ì•Šë”ë¼ë„, ì´ë ‡ê²Œ ê²½í—˜í•´ë³´ê³  ë‚˜ë©´ ì›ë˜ ë‚´ê°€ ì“°ë˜ ì½”ë“œì˜ ì§ˆì´ ì ì  ì¢‹ì•„ì§€ê¸°ë„ í•˜ëŠ” ê²ƒ ê°™ë‹¤.
